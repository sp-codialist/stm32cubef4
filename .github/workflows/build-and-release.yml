name: Build and Release Static Library

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write
  actions: read

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/kodezine/kdocker:latest
    strategy:
      fail-fast: false
      matrix:
        preset: [
          "stm32cubef4-r-gnuarm14.3",
          "stm32cubef4-d-gnuarm14.3"
        ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure CMake
      run: |
        cmake --preset ${{ matrix.preset }}

    - name: Build
      run: |
        cmake --build --preset ${{ matrix.preset }} --config $BUILD_TYPE

    - name: Test
      working-directory: build/${{ matrix.preset }}
      run: |
        ctest -C $BUILD_TYPE --output-on-failure

    - name: Package with CPack
      working-directory: build/${{ matrix.preset }}
      run: |
        # Create packages using CPack
        cpack -G "TGZ;ZIP" -C $BUILD_TYPE
        
        # List generated packages
        ls -la *.tar.gz *.zip

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.preset }}-packages
        path: |
          build/${{ matrix.preset }}/*.tar.gz
          build/${{ matrix.preset }}/*.zip

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts

    - name: Prepare release assets
      run: |
        # Create release directory and copy CPack generated packages
        mkdir -p release-assets
        
        # Debug: List all downloaded artifacts
        echo "Downloaded artifacts structure:"
        find artifacts/ -type f -name "*" | head -20
        
        # Copy all CPack generated tar.gz and zip files from artifacts
        find artifacts/ -name "*.tar.gz" -o -name "*.zip" -exec cp {} release-assets/ \;
        
        # Debug: List prepared release assets
        echo "Release assets prepared:"
        ls -la release-assets/
        
        # Ensure we have files to release
        if [ ! "$(ls -A release-assets/)" ]; then
          echo "Error: No release assets found!"
          exit 1
        fi

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF_NAME#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag_name=$GITHUB_REF_NAME" >> $GITHUB_OUTPUT

    - name: Generate release notes
      id: release_notes
      run: |
        cat > RELEASE_NOTES.md << EOF
        # STM32CubeF4 Static Library Release ${{ steps.get_version.outputs.tag_name }}
        
        ## What's Included
        
        This release contains pre-built static libraries with header files for STM32CubeF4:
        
        - **Debug Build**: Static library compiled with debug symbols
        - **Release Build**: Optimized static library for production use
        
        Each archive contains:
        - Static library (\`.a\` file)
        - Header files (\`.h\` files)  
        - CMake configuration files
        - License information
        
        ## Build Configuration
        
        - **STM32CubeF4 Version**: Package version corresponds to STM32CubeF4 library version
        - **Toolchain**: ARM GCC 14.3
        - **CMake Version**: 3.28+
        - **Target**: STM32F4 series microcontrollers
        
        ## Usage
        
        1. Extract the appropriate archive for your build type (debug/release)
        2. Add the library and include paths to your STM32F4 project
        3. Link against the static library
        
        ## Checksums
        
        \`\`\`
        EOF
        
        # Add checksums to release notes
        echo "\$(cd release-assets && sha256sum *.tar.gz *.zip 2>/dev/null || echo 'Checksums will be calculated after download')" >> RELEASE_NOTES.md
        echo "\`\`\`" >> RELEASE_NOTES.md

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.get_version.outputs.tag_name }}
        name: STM32CubeF4 Static Library ${{ steps.get_version.outputs.tag_name }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: ${{ contains(steps.get_version.outputs.tag_name, '-') }}
        files: release-assets/*
        fail_on_unmatched_files: true
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup:
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Delete temporary artifacts
      uses: geekyeggo/delete-artifact@v2
      with:
        name: |
          stm32cubef4-r-gnuarm14.3-packages
          stm32cubef4-d-gnuarm14.3-packages
        failOnError: false