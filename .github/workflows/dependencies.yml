name: Dependency Management

on:
  schedule:
    # Run weekly on Sundays at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
  push:
    paths:
      - 'CMakeLists.txt'
      - 'cmake/deps.*.cmake'
      - 'CMakePresets/**'

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.28'

    - name: Check for outdated dependencies
      run: |
        # Create a script to check for updates
        cat > check_deps.sh << 'EOF'
        #!/bin/bash
        
        echo "## Dependency Status Report" > dependency_report.md
        echo "" >> dependency_report.md
        echo "Generated on: $(date)" >> dependency_report.md
        echo "" >> dependency_report.md
        
        # Check STM32CubeF4 version
        if [ -f "CMakePresets/VersionPresets.json" ]; then
          CURRENT_VERSION=$(grep "GITHUB_BRANCH_stm32cubef4" CMakePresets/VersionPresets.json | cut -d'"' -f4)
          echo "### STM32CubeF4" >> dependency_report.md
          echo "- Current version: $CURRENT_VERSION" >> dependency_report.md
          
          # Check for latest release on GitHub
          LATEST=$(curl -s https://api.github.com/repos/STMicroelectronics/STM32CubeF4/releases/latest | jq -r .tag_name)
          if [ "$LATEST" != "null" ] && [ "$LATEST" != "$CURRENT_VERSION" ]; then
            echo "- Latest available: $LATEST" >> dependency_report.md
            echo "- ⚠️ Update available!" >> dependency_report.md
          else
            echo "- ✅ Up to date" >> dependency_report.md
          fi
          echo "" >> dependency_report.md
        fi
        
        # Check CMake version requirements
        echo "### Build Tools" >> dependency_report.md
        echo "- CMake minimum required: $(grep cmake_minimum_required CMakeLists.txt | cut -d'(' -f2 | cut -d')' -f1 | cut -d' ' -f3)" >> dependency_report.md
        echo "- CMake current: $(cmake --version | head -n1 | cut -d' ' -f3)" >> dependency_report.md
        echo "" >> dependency_report.md
        
        # Security scan for known vulnerabilities
        echo "### Security Status" >> dependency_report.md
        echo "- Last security scan: $(date)" >> dependency_report.md
        echo "- Status: Checking..." >> dependency_report.md
        
        EOF
        
        chmod +x check_deps.sh
        ./check_deps.sh

    - name: Security vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'json'
        output: 'vulnerability-report.json'
      continue-on-error: true

    - name: Process security results
      run: |
        if [ -f "vulnerability-report.json" ]; then
          # Count vulnerabilities by severity
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' vulnerability-report.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "MEDIUM")] | length' vulnerability-report.json 2>/dev/null || echo "0")
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "LOW")] | length' vulnerability-report.json 2>/dev/null || echo "0")
          
          echo "- High severity vulnerabilities: $HIGH" >> dependency_report.md
          echo "- Medium severity vulnerabilities: $MEDIUM" >> dependency_report.md  
          echo "- Low severity vulnerabilities: $LOW" >> dependency_report.md
          
          if [ "$HIGH" -gt "0" ]; then
            echo "- ⚠️ Action required for high severity issues" >> dependency_report.md
          else
            echo "- ✅ No high severity vulnerabilities found" >> dependency_report.md
          fi
        else
          echo "- ❓ Security scan failed or not available" >> dependency_report.md
        fi

    - name: Create issue for outdated dependencies
      uses: JasonEtco/create-an-issue@v2
      if: github.event_name == 'schedule'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        filename: .github/ISSUE_TEMPLATE/dependency-update.md
        update_existing: true
      continue-on-error: true

    - name: Upload dependency report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-report
        path: |
          dependency_report.md
          vulnerability-report.json

  license-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check licenses
      run: |
        echo "## License Compliance Report" > license_report.md
        echo "" >> license_report.md
        echo "Generated on: $(date)" >> license_report.md
        echo "" >> license_report.md
        
        # Check for license files
        if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
          echo "✅ Main license file found" >> license_report.md
        else
          echo "⚠️ No main license file found" >> license_report.md
        fi
        
        # Check for third-party licenses
        echo "" >> license_report.md
        echo "### Third-party Dependencies" >> license_report.md
        
        find _deps -name "LICENSE*" -o -name "COPYING*" 2>/dev/null | while read file; do
          echo "- $(dirname "$file" | sed 's|_deps/||'): $(basename "$file")" >> license_report.md
        done
        
        if [ ! -s license_report.md ] || ! grep -q "Third-party Dependencies" license_report.md; then
          echo "- No third-party license files found in _deps" >> license_report.md
        fi

    - name: Upload license report
      uses: actions/upload-artifact@v3
      with:
        name: license-report
        path: license_report.md